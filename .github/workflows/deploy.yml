name: Deploy to EC2 with Docker Compose

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Debug secrets (TEMPORAL)
        run: |
          echo "EC2_HOST definido: ${{ secrets.EC2_HOST != '' }}"
          echo "SSH Key definido: ${{ secrets.SSH_PRIVATE_KEY != '' }}"
          echo "Host: ${{ secrets.EC2_HOST }}"

      - name: Create SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/ec2_key
          chmod 600 ~/.ssh/ec2_key
          echo "Archivo creado:"
          ls -la ~/.ssh/ec2_key
          echo "Primera línea de la clave:"
          head -1 ~/.ssh/ec2_key
          echo "Validando clave:"
          ssh-keygen -l -f ~/.ssh/ec2_key || echo "Clave inválida"

      - name: Test SSH connection first
        run: |
          echo "Probando conexión SSH..."
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/ec2_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} 'echo "SSH funciona"' || {
            echo "SSH falló, probando con debug:"
            ssh -vvv -o StrictHostKeyChecking=no -i ~/.ssh/ec2_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} 'echo "SSH con debug"'
          }

      - name: Copy files to EC2
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/ec2_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} '
            mkdir -p ~/docker-apps/servers/hojavuelo-nest-server
          '
          scp -r -o StrictHostKeyChecking=no -i ~/.ssh/ec2_key ./ ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/docker-apps/servers/hojavuelo-nest-server/

      - name: Build and Deploy with Docker
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/ec2_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} '
            cd ~/docker-apps

            docker compose stop hojavuelo-nest-server || true
            docker compose rm -f hojavuelo-nest-server || true
            docker compose build --no-cache hojavuelo-nest-server
            docker compose up -d hojavuelo-nest-server
            docker exec nginx-proxy nginx -s reload
          '
